# Backy - Design Document

AI backup management service. Receive, store, preview, and restore backups sent by SaaS AI agents via webhooks.

## Architecture

| Layer | Technology |
|---|---|
| Runtime | Bun |
| Framework | Next.js 16 (App Router) |
| Language | TypeScript (strict mode) |
| UI | Tailwind CSS v4 + shadcn/ui (basalt design system) |
| Auth | NextAuth v5 + Google OAuth (whitelist) |
| Metadata DB | Cloudflare D1 (remote REST API) |
| File Storage | Cloudflare R2 (S3-compatible API) |
| Deployment | Railway + Docker, port 7026 |
| Domain | backy.dev.hexly.ai |

## Data Model (D1)

### projects

| Column | Type | Description |
|---|---|---|
| id | TEXT PK | nanoid |
| name | TEXT | Project name |
| description | TEXT? | Optional description |
| webhook_token | TEXT UNIQUE | Auto-generated, used by sender in Authorization header |
| created_at | TEXT | ISO 8601 |
| updated_at | TEXT | ISO 8601 |

### backups

| Column | Type | Description |
|---|---|---|
| id | TEXT PK | nanoid |
| project_id | TEXT FK | → projects.id |
| environment | TEXT? | dev/prod, sender-defined |
| sender_ip | TEXT | Request IP |
| tag | TEXT? | Sender-defined label |
| file_key | TEXT | R2 object key (zip) |
| json_key | TEXT? | R2 object key (extracted json) |
| file_size | INTEGER | Bytes |
| is_single_json | INTEGER | 1 if zip contains a single .json file |
| json_extracted | INTEGER | 1 if user chose to extract json |
| created_at | TEXT | ISO 8601 |
| updated_at | TEXT | ISO 8601 |

## R2 Storage Layout

```
backy-bucket/
├── {project_id}/
│   ├── {backup_id}.zip
│   └── {backup_id}.json        # only when user extracts
```

## API Routes

```
/api/auth/[...nextauth]       Auth handlers
/api/projects                 GET (list), POST (create)
/api/projects/[id]            GET, PUT, DELETE
/api/projects/[id]/token      POST (regenerate webhook token)
/api/projects/[id]/prompt     GET (AI agent integration guide)
/api/webhook/[projectId]      POST (receive backup zip, multipart/form-data)
/api/backups                  GET (list all, with filters)
/api/backups/[id]             GET, DELETE
/api/backups/[id]/download    GET (download zip from R2)
/api/backups/[id]/extract     POST (extract json from zip)
/api/backups/[id]/preview     GET (load json for preview)
/api/restore/[id]             GET (authenticated temp download URL for SaaS)
/api/live                     Health check
```

## Pages

```
/login                        Badge Login (Google OAuth)
/                             Dashboard (backup stats overview)
/projects                     Project list
/projects/new                 Create project
/projects/[id]                Project detail + backup list
/projects/[id]/settings       Project settings (edit, token, prompt)
/backups                      Global backup list (filter/search/multi-select)
/backups/[id]                 Backup detail (metadata, json preview, download, restore)
```

## Webhook Protocol

### Sending a backup

```
POST /api/webhook/{projectId}
Authorization: Bearer {webhook_token}
Content-Type: multipart/form-data

Fields:
  file: (zip file)
  environment?: "dev" | "prod" (optional)
  tag?: string (optional)
```

### Restoring a backup

```
GET /api/restore/{backupId}?token={restore_token}
→ Returns the backup file (zip or json)
```

Restore tokens are temporary, generated by backy when user clicks "Generate Restore URL".

## Security

- **Web UI**: Google OAuth + ALLOWED_EMAILS whitelist (single-user/small team)
- **Webhook**: Per-project Bearer token in Authorization header
- **Restore**: Temporary signed URLs with expiration
- **R2/D1**: Access keys stored as server-side environment variables

## Implementation Phases

### Phase 1: Scaffold & Auth ✅ DONE
- [x] Design document
- [x] Initialize Next.js project (bun, package.json, tsconfig, next.config)
- [x] Basalt design system (CSS tokens, shadcn/ui, layout)
- [x] Tailwind v4 + postcss
- [x] NextAuth v5 + Google OAuth + whitelist
- [x] Badge Login page (from surety)
- [x] App Shell (placeholder dashboard page)
- [x] proxy.ts (Next.js 16 middleware)
- [x] Husky + pre-commit (UT+lint) + pre-push (UT+lint)
- [x] ESLint + strict mode (tsconfig strict + noUncheckedIndexedAccess + noUnusedLocals + exactOptionalPropertyTypes)
- [x] Test framework (bun test) + initial tests (utils, health)
- [x] Dockerfile + .env.example + CLAUDE.md

### Phase 2: Project Management ✅ DONE
- [x] D1 client setup + schema initialization
- [x] R2 client setup (S3-compatible)
- [x] Project CRUD API
- [x] Project management pages (list, create, detail/settings)
- [x] Webhook token generation & display
- [x] AI agent integration prompt generation
- [x] App Shell with collapsible sidebar and breadcrumbs

### Phase 3: Backup Receiving (Webhook) ✅ DONE
- [x] Webhook endpoint (receive zip/json via multipart/form-data)
- [x] Bearer token verification
- [x] JSON file detection (single json support)
- [x] R2 upload + D1 metadata insert
- [x] Request metadata extraction (IP, environment, tag)
- [x] Content-type validation with charset handling
- [x] File size limit (50 MB)

### Phase 4: Backup Management UI ✅ DONE (Core)
- [x] Backup list page (global)
- [x] Dashboard with live stats (projects, backups, storage)
- [x] Single backup operations (download, delete)
- [x] Stats API endpoint
- [ ] Filter, search, sort
- [ ] Multi-select + batch operations
- [ ] Pagination
- [ ] Per-project backup list on project detail page

### Phase 5: JSON Preview & Restore
- [ ] JSON extraction (unzip to R2)
- [ ] JSON tree preview in UI
- [ ] Restore URL generation (temporary signed URL)
- [ ] Restore API endpoint

### Phase 6: Testing & Deployment
- [ ] Unit tests (90%+ coverage)
- [ ] API E2E tests
- [ ] Lint (zero errors/warnings)
- [ ] Husky hooks (pre-commit: UT+lint, pre-push: UT+lint+E2E)
- [ ] Dockerfile (3-stage build)
- [ ] Railway deployment config
